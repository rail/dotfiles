#!/bin/bash
set -e
sync=0
while true; do
    if ! getopts l:s opt; then
        break;
    fi

    if [ $opt == l ]; then
        login="-l $OPTARG"
        shift 2
    elif [ $opt == s ]; then
        sync=1
        shift
    elif [ $opt == ? ]; then
        break
    fi
done

TARGET="T$RANDOM"
new=0
for h in $*; do
    if [ "$new" = "0" ]; then
        tmux new-window -n $TARGET "ssh $login $h"
        new=1
    else
        tmux split-window -t $TARGET "ssh $login $h"
    fi
    tmux select-layout -t $TARGET even-vertical
done
if [ $sync == 1 ]; then
    tmux set-option -t $TARGET sync on
fi
